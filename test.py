import uvicorn
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import time

app = FastAPI()

# --- 1. 配置 CORS (解决跨域问题) ---
# 必须配置，因为你的 HTML 可能是直接打开文件 (file://) 或在不同端口运行
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 允许所有来源
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# --- 2. 定义请求模型 ---
class FeishuRequest(BaseModel):
    doc_url: str
    app_id: str
    app_secret: str


# --- 3. 准备 Mock 数据 (你提供的数据) ---
# 注意：我们将 'analysis_and_plan' 映射给前端需要的 'analysis
MOCK_DATA1 = {
    "detected_modules": ["账号登录", "重置初始密码", "找回密码", "修改密码"],
    "analysis_and_plan": [
        {
            "module_name": "账号登录",
            "identified_inputs": ["登录账号输入框", "密码输入框", "验证码输入框", "登录按钮", "找回密码按钮", "密码明文查看按钮", "账号清空按钮", "密码清空按钮"],
            "business_constraints": [
                "账号、密码、验证码需正确才能登录",
                "验证码为4位大写字母，有效期60秒",
                "首次登录需弹出修改初始密码弹窗",
                "输入框获取焦点时边框变绿，失焦时恢复原状",
                "密码输入后显示明文查看和清空按钮，按下明文查看按钮时密码明文显示，松开时密文显示",
                "登录按钮点击后依次校验账号、密码、验证码，错误时对应输入框下方红字提示",
                "找回密码按钮点击后跳转至找回密码页面"
            ],
            "planned_stream_a_scenarios": [
                "合法账号+正确密码+正确验证码登录（首次登录弹窗提示）",
                "账号不存在登录",
                "密码错误登录",
                "验证码错误登录",
                "验证码过期登录",
                "未输入账号登录",
                "未输入密码登录",
                "未输入验证码登录",
                "密码明文查看按钮功能",
                "账号清空按钮功能",
                "密码清空按钮功能",
                "找回密码按钮跳转",
                "输入框失焦后边框恢复"
            ],
            "planned_stream_b_scenarios": [
                "输入框空值（账号、密码、验证码为空）",
                "输入框超长（账号、密码、验证码超过限制长度）",
                "验证码大小写错误（输入小写字母）",
                "密码明文查看按钮UI反馈（按下/松开状态）",
                "输入框焦点样式（获取焦点边框绿，失焦恢复）",
                "多次点击登录按钮（幂等性）",
                "网络中断时点击登录"
            ]
        },
        {
            "module_name": "重置初始密码",
            "identified_inputs": ["新密码输入框", "确认密码输入框", "验证短信输入框", "获取验证码按钮", "取消按钮", "提交按钮", "密码明文查看按钮（新密码、确认密码）", "清空按钮（新密码、确认密码）"],
            "business_constraints": [
                "新密码和确认密码需一致，且至少包含两种字符（数字、小写、大写、特殊符号）",
                "验证码为6位数字，有效期60秒",
                "获取验证码后按钮倒计时60秒",
                "输入框获取焦点时边框变绿，失焦时恢复原状",
                "密码输入后显示明文查看和清空按钮，按下明文查看按钮时密码明文显示，松开时密文显示",
                "提交按钮点击后依次校验新密码、确认密码、验证码，错误时对应输入框下方红字提示",
                "取消按钮点击后返回至登录页面",
                "首次登录后跳转至此页面"
            ],
            "planned_stream_a_scenarios": [
                "合法新密码+确认密码+正确验证码提交（重置成功）",
                "新密码与确认密码不一致提交",
                "新密码复杂度不足提交",
                "验证码错误提交",
                "验证码过期提交",
                "未输入新密码提交",
                "未输入确认密码提交",
                "未输入验证码提交",
                "密码明文查看按钮功能（新密码、确认密码）",
                "新密码清空按钮功能",
                "确认密码清空按钮功能",
                "获取验证码按钮倒计时",
                "取消按钮跳转",
                "输入框失焦后边框恢复"
            ],
            "planned_stream_b_scenarios": [
                "输入框空值（新密码、确认密码、验证码为空）",
                "输入框超长（新密码、确认密码、验证码超过限制长度）",
                "新密码复杂度不足（仅一种字符类型）",
                "验证码非数字输入（输入字母）",
                "密码明文查看按钮UI反馈（按下/松开状态）",
                "输入框焦点样式（获取焦点边框绿，失焦恢复）",
                "多次点击提交按钮（幂等性）",
                "网络中断时提交"
            ]
        },
        {
            "module_name": "找回密码",
            "identified_inputs": ["登录账号输入框（手机号）", "新密码输入框", "确认密码输入框", "验证短信输入框", "获取验证码按钮", "取消按钮", "提交按钮", "密码明文查看按钮（新密码、确认密码）", "清空按钮（新密码、确认密码）"],
            "business_constraints": [
                "新密码和确认密码需一致，且至少包含两种字符（数字、小写、大写、特殊符号）",
                "验证码为6位数字，有效期60秒",
                "获取验证码后按钮倒计时60秒",
                "输入框获取焦点时边框变绿，失焦时恢复原状",
                "密码输入后显示明文查看和清空按钮，按下明文查看按钮时密码明文显示，松开时密文显示",
                "提交按钮点击后依次校验新密码、确认密码、验证码，错误时对应输入框下方红字提示",
                "取消按钮点击后返回至登录页面"
            ],
            "planned_stream_a_scenarios": [
                "合法手机号+正确新密码+确认密码+正确验证码提交（重置成功）",
                "手机号不存在提交",
                "新密码与确认密码不一致提交",
                "新密码复杂度不足提交",
                "验证码错误提交",
                "验证码过期提交",
                "未输入手机号提交",
                "未输入新密码提交",
                "未输入确认密码提交",
                "未输入验证码提交",
                "密码明文查看按钮功能（新密码、确认密码）",
                "新密码清空按钮功能",
                "确认密码清空按钮功能",
                "获取验证码按钮倒计时",
                "取消按钮跳转",
                "输入框失焦后边框恢复"
            ],
            "planned_stream_b_scenarios": [
                "输入框空值（手机号、新密码、确认密码、验证码为空）",
                "输入框超长（手机号、新密码、确认密码、验证码超过限制长度）",
                "新密码复杂度不足（仅一种字符类型）",
                "验证码非数字输入（输入字母）",
                "密码明文查看按钮UI反馈（按下/松开状态）",
                "输入框焦点样式（获取焦点边框绿，失焦恢复）",
                "多次点击提交按钮（幂等性）",
                "网络中断时提交"
            ]
        },
        {
            "module_name": "修改密码",
            "identified_inputs": ["原密码输入框", "新密码输入框", "确认密码输入框", "验证短信输入框", "获取验证码按钮", "取消按钮", "提交按钮", "密码明文查看按钮（原密码、新密码、确认密码）", "清空按钮（原密码、新密码、确认密码）"],
            "business_constraints": [
                "原密码需正确，新密码和确认密码需一致，且至少包含两种字符（数字、小写、大写、特殊符号）",
                "验证码为6位数字，有效期60秒",
                "获取验证码后按钮倒计时60秒",
                "输入框获取焦点时边框变绿，失焦时恢复原状",
                "密码输入后显示明文查看和清空按钮，按下明文查看按钮时密码明文显示，松开时密文显示",
                "提交按钮点击后依次校验原密码、新密码、确认密码、验证码，错误时对应输入框下方红字提示",
                "取消按钮点击后返回至我的页面",
                "需成功登录后才能进入修改密码页面"
            ],
            "planned_stream_a_scenarios": [
                "正确原密码+合法新密码+确认密码+正确验证码提交（重置成功）",
                "原密码错误提交",
                "新密码与确认密码不一致提交",
                "新密码复杂度不足提交",
                "验证码错误提交",
                "验证码过期提交",
                "未输入原密码提交",
                "未输入新密码提交",
                "未输入确认密码提交",
                "未输入验证码提交",
                "密码明文查看按钮功能（原密码、新密码、确认密码）",
                "原密码清空按钮功能",
                "新密码清空按钮功能",
                "确认密码清空按钮功能",
                "获取验证码按钮倒计时",
                "取消按钮跳转",
                "输入框失焦后边框恢复"
            ],
            "planned_stream_b_scenarios": [
                "输入框空值（原密码、新密码、确认密码、验证码为空）",
                "输入框超长（原密码、新密码、确认密码、验证码超过限制长度）",
                "新密码复杂度不足（仅一种字符类型）",
                "验证码非数字输入（输入字母）",
                "密码明文查看按钮UI反馈（按下/松开状态）",
                "输入框焦点样式（获取焦点边框绿，失焦恢复）",
                "多次点击提交按钮（幂等性）",
                "网络中断时提交"
            ]
        }
    ],
    "cases": [
        {
            "module_name": "账号登录",
            "title": "合法账号密码验证码登录（首次登录）",
            "type": "Stream A",
            "pre_condition": "系统正常，登录页面加载完成，账号为首次登录且合法，密码正确，验证码正确（4位大写字母，未过期）",
            "visual_evidence": "基于[参考图2-UI]的登录流程和首次登录弹窗",
            "steps": [
                "输入合法登录账号",
                "输入正确密码",
                "输入正确验证码",
                "点击登录按钮"
            ],
            "expected_result": "登录成功，弹出“账号首次登录时需要重置初始密码”弹窗，点击确定跳转修改初始密码页面"
        },
        {
            "module_name": "账号登录",
            "title": "账号不存在登录",
            "type": "Stream A",
            "pre_condition": "系统正常，登录页面加载完成，账号为未注册账号，密码正确，验证码正确",
            "visual_evidence": "基于[参考图1-流程图]的登录否决分支",
            "steps": [
                "输入不存在的账号",
                "输入正确密码",
                "输入正确验证码",
                "点击登录按钮"
            ],
            "expected_result": "登录失败，账号输入框下方红字提示“输入账号不存在”"
        },
        {
            "module_name": "账号登录",
            "title": "密码错误登录",
            "type": "Stream A",
            "pre_condition": "系统正常，登录页面加载完成，账号合法，密码错误，验证码正确",
            "visual_evidence": "基于[参考图1-流程图]的登录否决分支",
            "steps": [
                "输入合法账号",
                "输入错误密码",
                "输入正确验证码",
                "点击登录按钮"
            ],
            "expected_result": "登录失败，密码输入框下方红字提示“输入密码错误”"
        },
        {
            "module_name": "账号登录",
            "title": "验证码错误登录",
            "type": "Stream A",
            "pre_condition": "系统正常，登录页面加载完成，账号合法，密码正确，验证码错误",
            "visual_evidence": "基于[参考图1-流程图]的登录否决分支",
            "steps": [
                "输入合法账号",
                "输入正确密码",
                "输入错误验证码",
                "点击登录按钮"
            ],
            "expected_result": "登录失败，验证码输入框下方红字提示“验证码错误”"
        },
        {
            "module_name": "账号登录",
            "title": "密码明文查看按钮功能",
            "type": "Stream A",
            "pre_condition": "系统正常，登录页面加载完成，密码输入框已输入密码",
            "visual_evidence": "基于[参考图2-UI]的密码明文查看按钮",
            "steps": [
                "输入密码到密码输入框",
                "按下密码明文查看按钮",
                "松开密码明文查看按钮"
            ],
            "expected_result": "按下时密码明文显示，松开时密码密文显示"
        },
        {
            "module_name": "账号登录",
            "title": "找回密码按钮跳转",
            "type": "Stream A",
            "pre_condition": "系统正常，登录页面加载完成",
            "visual_evidence": "基于[参考图2-UI]的找回密码按钮",
            "steps": [
                "点击找回密码按钮"
            ],
            "expected_result": "页面跳转到找回密码页面"
        },
        {
            "module_name": "账号登录",
            "title": "输入框焦点样式（账号输入框）",
            "type": "Stream B",
            "pre_condition": "系统正常，登录页面加载完成",
            "visual_evidence": "基于[参考图2-UI]的输入框焦点样式",
            "steps": [
                "点击账号输入框"
            ],
            "expected_result": "账号输入框边框变为绿色，提示文字消失"
        },
        {
            "module_name": "账号登录",
            "title": "验证码大小写错误登录",
            "type": "Stream B",
            "pre_condition": "系统正常，登录页面加载完成，账号合法，密码正确，验证码为小写字母",
            "visual_evidence": "基于[参考图2-UI]的验证码说明（4位大写字母）",
            "steps": [
                "输入合法账号",
                "输入正确密码",
                "输入小写字母验证码（如axzy）",
                "点击登录按钮"
            ],
            "expected_result": "登录失败，验证码输入框下方红字提示“验证码错误”"
        },
        {
            "module_name": "重置初始密码",
            "title": "合法新密码确认密码验证码提交（重置初始密码）",
            "type": "Stream A",
            "pre_condition": "系统正常，重置初始密码页面加载完成，新密码符合复杂度（8-10位，两种字符），确认密码与新密码一致，验证码正确（6位数字，未过期）",
            "visual_evidence": "基于[参考图3-UI]的重置初始密码页面",
            "steps": [
                "输入符合要求的新密码",
                "输入与新密码一致的确认密码",
                "点击获取验证码按钮",
                "输入正确验证码",
                "点击提交按钮"
            ],
            "expected_result": "提示重置密码成功，返回登录页面"
        },
        {
            "module_name": "重置初始密码",
            "title": "新密码与确认密码不一致提交",
            "type": "Stream A",
            "pre_condition": "系统正常，重置初始密码页面加载完成，新密码符合复杂度，确认密码与新密码不一致，验证码正确",
            "visual_evidence": "基于[参考图3-UI]的确认密码输入框",
            "steps": [
                "输入符合要求的新密码",
                "输入与新密码不一致的确认密码",
                "点击获取验证码按钮",
                "输入正确验证码",
                "点击提交按钮"
            ],
            "expected_result": "提交失败，确认密码输入框下方红字提示“两次输入密码不一致”"
        },
        {
            "module_name": "重置初始密码",
            "title": "输入框焦点样式（新密码输入框）",
            "type": "Stream B",
            "pre_condition": "系统正常，重置初始密码页面加载完成",
            "visual_evidence": "基于[参考图3-UI]的输入框焦点样式",
            "steps": [
                "点击新密码输入框"
            ],
            "expected_result": "新密码输入框边框变为绿色，提示文字消失"
        },
        {
            "module_name": "找回密码",
            "title": "合法手机号新密码验证码提交（找回密码）",
            "type": "Stream A",
            "pre_condition": "系统正常，找回密码页面加载完成，手机号合法且已注册，新密码符合复杂度，确认密码与新密码一致，验证码正确（6位数字，未过期）",
            "visual_evidence": "基于[参考图4-UI]的找回密码页面",
            "steps": [
                "输入合法手机号",
                "输入符合要求的新密码",
                "输入与新密码一致的确认密码",
                "点击获取验证码按钮",
                "输入正确验证码",
                "点击提交按钮"
            ],
            "expected_result": "提示重置密码成功，返回登录页面"
        },
        {
            "module_name": "修改密码",
            "title": "正确原密码新密码验证码提交（修改密码）",
            "type": "Stream A",
            "pre_condition": "系统正常，修改密码页面加载完成，用户已登录，原密码正确，新密码符合复杂度，确认密码与新密码一致，验证码正确（6位数字，未过期）",
            "visual_evidence": "基于[参考图5-UI]的修改密码页面",
            "steps": [
                "输入正确原密码",
                "输入符合要求的新密码",
                "输入与新密码一致的确认密码",
                "点击获取验证码按钮",
                "输入正确验证码",
                "点击提交按钮"
            ],
            "expected_result": "提示重置密码成功，留在我的页面"
        }
    ],
    "images": {}
}
MOCK_DATA = {
    "detected_modules": ["账号登录", "重置初始密码", "找回密码", "修改密码"],
    "analysis_and_plan": [
        {
            "module_name": "账号登录",
            "identified_inputs": ["登录账号输入框", "密码输入框", "验证码输入框", "登录按钮", "找回密码按钮", "密码明文查看按钮", "密码清空按钮", "账号清空按钮", "验证码刷新区域"],
            "business_constraints": [
                "账号、密码、验证码需校验通过才能登录",
                "账号输入后显示账号清空按钮",
                "密码输入后显示密码明文查看按钮和密码清空按钮",
                "验证码为4位大写英文字母，有效期60秒",
                "账号首次登录需修改初始密码"
            ],
            "planned_stream_a_scenarios": [
                "合法账号+密码+验证码登录成功（首次登录弹窗提示修改初始密码）",
                "账号不合法时登录（校验失败）",
                "密码不合法时登录（校验失败）",
                "验证码错误时登录（校验失败）",
                "验证码过期时登录（校验失败）",
                "未输入账号点击登录（校验失败）",
                "未输入密码点击登录（校验失败）",
                "未输入验证码点击登录（校验失败）"
            ],
            "planned_stream_b_scenarios": [
                "账号输入框空值测试",
                "密码输入框空值测试",
                "验证码输入框空值测试",
                "账号输入框超长字符测试",
                "密码输入框超长字符测试",
                "验证码输入框超长字符测试",
                "密码明文查看按钮功能测试（按下/松开）",
                "账号清空按钮功能测试",
                "密码清空按钮功能测试",
                "验证码刷新功能测试",
                "输入框焦点样式测试（获取/失去焦点）",
                "XSS攻击测试（输入脚本到输入框）",
                "网络中断时点击登录测试"
            ]
        },
        {
            "module_name": "重置初始密码",
            "identified_inputs": ["新密码输入框", "确认密码输入框", "验证码输入框", "获取验证码按钮", "提交按钮", "取消按钮", "密码明文查看按钮", "密码清空按钮"],
            "business_constraints": [
                "新密码和确认密码需一致且符合复杂度要求（8-10位，至少两种字符类型）",
                "验证码为6位数字，有效期60秒",
                "提交需校验密码和验证码",
                "取消返回登录页面",
                "仅首次登录账号需修改初始密码"
            ],
            "planned_stream_a_scenarios": [
                "合法新密码+确认密码+验证码提交成功",
                "新密码不符合复杂度提交（校验失败）",
                "新密码与确认密码不一致提交（校验失败）",
                "验证码错误提交（校验失败）",
                "验证码过期提交（校验失败）",
                "未输入新密码提交（校验失败）",
                "未输入确认密码提交（校验失败）",
                "未输入验证码提交（校验失败）",
                "未点击获取验证码提交（校验失败）"
            ],
            "planned_stream_b_scenarios": [
                "新密码输入框空值测试",
                "确认密码输入框空值测试",
                "验证码输入框空值测试",
                "新密码输入框超长字符测试",
                "确认密码输入框超长字符测试",
                "验证码输入框超长字符测试",
                "密码明文查看按钮功能测试（按下/松开）",
                "密码清空按钮功能测试",
                "输入框焦点样式测试（获取/失去焦点）",
                "XSS攻击测试（输入脚本到输入框）",
                "网络中断时点击提交测试"
            ]
        },
        {
            "module_name": "找回密码",
            "identified_inputs": ["登录账号输入框", "新密码输入框", "确认密码输入框", "验证码输入框", "获取验证码按钮", "提交按钮", "取消按钮", "密码明文查看按钮", "密码清空按钮"],
            "business_constraints": [
                "新密码和确认密码需一致且符合复杂度要求（8-10位，至少两种字符类型）",
                "验证码为6位数字，有效期60秒",
                "提交需校验密码和验证码",
                "取消返回登录页面",
                "登录账号需为已注册且绑定手机号的账号"
            ],
            "planned_stream_a_scenarios": [
                "合法账号+新密码+确认密码+验证码提交成功",
                "账号不合法提交（校验失败）",
                "新密码不符合复杂度提交（校验失败）",
                "新密码与确认密码不一致提交（校验失败）",
                "验证码错误提交（校验失败）",
                "验证码过期提交（校验失败）",
                "未输入账号提交（校验失败）",
                "未输入新密码提交（校验失败）",
                "未输入确认密码提交（校验失败）",
                "未输入验证码提交（校验失败）",
                "未点击获取验证码提交（校验失败）"
            ],
            "planned_stream_b_scenarios": [
                "账号输入框空值测试",
                "新密码输入框空值测试",
                "确认密码输入框空值测试",
                "验证码输入框空值测试",
                "账号输入框超长字符测试",
                "新密码输入框超长字符测试",
                "确认密码输入框超长字符测试",
                "验证码输入框超长字符测试",
                "密码明文查看按钮功能测试（按下/松开）",
                "密码清空按钮功能测试",
                "输入框焦点样式测试（获取/失去焦点）",
                "XSS攻击测试（输入脚本到输入框）",
                "网络中断时点击提交测试"
            ]
        },
        {
            "module_name": "修改密码",
            "identified_inputs": ["原密码输入框", "新密码输入框", "确认密码输入框", "验证码输入框", "获取验证码按钮", "提交按钮", "取消按钮", "密码明文查看按钮", "密码清空按钮"],
            "business_constraints": [
                "原密码需正确",
                "新密码和确认密码需一致且符合复杂度要求（8-10位，至少两种字符类型）",
                "验证码为6位数字，有效期60秒",
                "提交需校验原密码、新密码和验证码",
                "取消返回我的页面",
                "需已成功登录账号"
            ],
            "planned_stream_a_scenarios": [
                "合法原密码+新密码+确认密码+验证码提交成功",
                "原密码错误提交（校验失败）",
                "新密码不符合复杂度提交（校验失败）",
                "新密码与确认密码不一致提交（校验失败）",
                "验证码错误提交（校验失败）",
                "验证码过期提交（校验失败）",
                "未输入原密码提交（校验失败）",
                "未输入新密码提交（校验失败）",
                "未输入确认密码提交（校验失败）",
                "未输入验证码提交（校验失败）",
                "未点击获取验证码提交（校验失败）"
            ],
            "planned_stream_b_scenarios": [
                "原密码输入框空值测试",
                "新密码输入框空值测试",
                "确认密码输入框空值测试",
                "验证码输入框空值测试",
                "原密码输入框超长字符测试",
                "新密码输入框超长字符测试",
                "确认密码输入框超长字符测试",
                "验证码输入框超长字符测试",
                "密码明文查看按钮功能测试（按下/松开）",
                "密码清空按钮功能测试",
                "输入框焦点样式测试（获取/失去焦点）",
                "XSS攻击测试（输入脚本到输入框）",
                "网络中断时点击提交测试"
            ]
        }
    ],
    "cases": [
        {"module_name": "账号登录", "title": "合法账号密码验证码首次登录", "type": "Stream A", "pre_condition": "系统处于登录页面...", "steps": ["输入合法账号"], "expected_result": "登录成功..."},
        {"module_name": "账号登录", "title": "账号格式不合法登录", "type": "Stream A", "pre_condition": "系统处于登录页面...", "steps": ["输入不合法账号"], "expected_result": "登录失败..."}
    ],
    "images": {}
}

# --- 4. 定义 API 接口 ---
@app.post("/generate_from_feishu")
async def generate_cases(request: FeishuRequest):
    print(f"收到请求: URL={request.doc_url}")

    # 模拟 AI 处理延时 (让前端显示 Loading 动画)
    time.sleep(1.5)

    # 返回前端要求的格式
    return {
        "status": "success",
        "message": "生成成功",
        "data": MOCK_DATA
    }


if __name__ == "__main__":
    # 启动服务，端口 8000
    uvicorn.run(app, host="0.0.0.0", port=8000)