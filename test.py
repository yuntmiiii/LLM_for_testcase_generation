import uvicorn
import json
import asyncio
import traceback
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import StreamingResponse, HTMLResponse
from fastapi.staticfiles import StaticFiles  # 导入静态文件
from pydantic import BaseModel, Field

# --- 导入数据库服务 (假设 db 模块存在) ---
try:
    # 假设您的 db.py 提供了 save_result, get_result_by_key, init_db
    from db import save_result, get_result_by_key, init_db
    init_db()
except ImportError:
    print("WARNING: db.py not found. Using mock functions for Save/Load.")

    def save_result(data):
        return "mock_key"

    def get_result_by_key(key):
        # 简单 Mock，加载 MOCK_DATA_ALL
        if key == "mock_key":
            return MOCK_DATA_ALL
        return None

app = FastAPI(title="基于LLM的测试用例生成 Mock Server")

# 允许跨域
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# 定义请求体结构
class FeishuRequest(BaseModel):
    doc_url: str
    app_id: str = ""
    app_secret: str = ""


class CaseSaveRequest(BaseModel):
    # 保存时需要发送的完整数据结构
    final_json: dict = Field(..., description="最终生成的测试用例和分析的 JSON 结构")


# --- MOCK 数据结构 (保持不变) ---
MOCK_DATA_ALL = {
    # 保持完整的 mock 数据结构...
    "analysis": [
        {
            "module_name": "账号登录",
            "identified_inputs": ["登录账号输入框", "密码输入框", "验证码输入框", "密码明文查看按钮", "密码清空按钮",
                                  "验证码刷新区域", "登录按钮", "找回密码按钮"],
            "involved_roles": ["B端产品用户"],
            "data_requirements": ["不存在的登录账号", "错误的登录密码", "过期的验证码", "锁定的账号", "失效的账号",
                                  "空的登录账号输入", "空的密码输入", "空的验证码输入", "正确的登录账号、密码、验证码",
                                  "4位小写字母的验证码"],
            "risk_assessment": "High，理由：涉及账号安全，是系统访问的核心入口，登录流程失败会导致用户无法使用系统功能，且包含密码、验证码等敏感信息校验。",
            "business_constraints": [
                "登录账号不为空",
                "登录账号存在于系统",
                "登录密码不为空",
                "登录密码与账号匹配",
                "验证码不为空",
                "验证码正确且在有效期（60秒）内",
                "账号未被锁定",
                "账号未失效",
                "输入框获取焦点时提示文字消失，边框变绿；失去焦点恢复",
                "密码支持明文/密文切换（鼠标按下显示明文，松开恢复密文）",
                "密码输入框支持清空操作",
                "验证码支持点击刷新",
                "找回密码按钮点击后跳转至找回密码页面"
            ],
            "planned_stream_a_scenarios": [
                "P0 Happy Path：输入正确账号、密码、有效验证码，点击登录成功（首次登录弹出修改初始密码提示）",
                "P1 登录账号为空：输入空账号，点击登录提示账号不为空",
                "P1 登录账号不存在：输入不存在的账号，点击登录提示账号不存在",
                "P1 登录密码为空：输入空密码，点击登录提示密码不为空",
                "P1 登录密码错误：输入错误密码，点击登录提示密码错误",
                "P1 验证码为空：输入空验证码，点击登录提示验证码不为空",
                "P1 验证码过期：输入有效验证码后等待60秒，点击登录提示验证码失效"
            ],
            "planned_stream_b_scenarios": [
                "输入框焦点样式：点击账号输入框，提示文字消失且边框变绿；失去焦点恢复",
                "密码明文/密文切换：按下密码明文查看按钮显示明文，松开恢复密文",
                "密码清空操作：输入密码后点击清空按钮，密码输入框清空",
                "验证码刷新：点击验证码区域，验证码刷新为新的4位大写字母",
                "验证码有效期：等待60秒后输入原验证码，登录提示验证码失效",
                "找回密码跳转：点击找回密码按钮，跳转到找回密码页面"
            ],
            "planned_stream_c_scenarios": [
                "首次登录成功：登录后弹出修改初始密码提示，点击确定跳转至修改初始密码页面",
                "非首次登录成功：登录后直接进入系统首页",
                "登录失败触发锁定：多次密码错误后账号锁定，再次登录提示账号锁定",
                "验证码刷新后登录：点击刷新验证码后输入新验证码，登录成功",
                "密码明文查看后登录：按下明文查看确认密码正确，松开后点击登录成功",
                "找回密码后登录：通过找回密码重置密码后，使用新密码登录成功"
            ]
        },
        {
            "module_name": "重置初始密码",
            "identified_inputs": ["新密码输入框", "确认密码输入框", "验证码输入框", "获取验证码按钮", "提交按钮",
                                  "取消按钮", "密码明文查看按钮", "密码清空按钮"],
            "involved_roles": ["首次登录的B端产品用户"],
            "data_requirements": ["7位的新密码（不符合长度）", "只有数字的新密码（不符合复杂度）",
                                  "与新密码不一致的确认密码", "过期的验证码", "未获取的验证码（直接输入）",
                                  "错误的验证码", "空的新密码输入", "空的确认密码输入", "空的验证码输入",
                                  "符合要求的新密码、确认密码、有效验证码"],
            "risk_assessment": "High，理由：涉及首次登录后的密码修改，是账号安全的重要环节，密码修改失败会导致用户无法完成初始密码设置，影响后续登录。",
            "business_constraints": [
                "新密码不为空",
                "新密码长度为8-10位，且至少包含两种字符类型（数字、小写字母、大写字母、特殊符号）",
                "确认密码与新密码一致",
                "验证码不为空",
                "验证码正确且在有效期（60秒）内",
                "输入框获取焦点时提示文字消失，边框变绿；失去焦点恢复",
                "密码支持明文/密文切换（鼠标按下显示明文，松开恢复密文）",
                "密码输入框支持清空操作",
                "获取验证码按钮点击后显示60秒倒计时，倒计时结束后恢复",
                "取消按钮点击后返回登录页面"
            ],
            "planned_stream_a_scenarios": [
                "P0 Happy Path：输入符合要求的新密码、确认密码、有效验证码，提交成功提示重置成功",
                "P1 新密码为空：输入空新密码，提交提示密码不为空",
                "P1 新密码长度不足：输入7位新密码，提交提示长度错误",
                "P1 新密码复杂度不足：输入只有数字的新密码，提交提示复杂度不足",
                "P1 确认密码不一致：输入与新密码不同的确认密码，提交提示不一致",
                "P1 验证码为空：输入空验证码，提交提示验证码不为空",
                "P1 验证码过期：获取验证码后等待60秒，输入原验证码提交提示失效"
            ],
            "planned_stream_b_scenarios": [
                "输入框焦点样式：点击新密码输入框，提示文字消失且边框变绿；失去焦点恢复",
                "密码明文/密文切换：按下新密码明文查看按钮显示明文，松开恢复密文",
                "密码清空操作：输入新密码后点击清空按钮，密码输入框清空",
                "获取验证码倒计时：点击获取验证码按钮，显示60秒倒计时，结束后恢复",
                "验证码有效期：等待60秒后输入原验证码，提交提示失效",
                "取消按钮跳转：点击取消按钮，返回登录页面"
            ],
            "planned_stream_c_scenarios": [
                "重置成功后登录：提交成功后返回登录页面，使用新密码登录成功",
                "重置失败后留在页面：输入错误信息，提交后提示错误留在页面",
                "首次登录重置流程：登录后弹出提示，点击确定跳转至重置页面",
                "验证码倒计时期间提交：倒计时期间输入验证码，提交成功（有效时）",
                "密码明文查看后提交：按下明文查看确认密码正确，松开后提交成功",
                "取消后重新登录：点击取消返回登录页面，再次登录仍提示修改初始密码"
            ]
        },
        {
            "module_name": "找回密码",
            "identified_inputs": ["登录账号（手机号）输入框", "新密码输入框", "确认密码输入框", "验证码输入框",
                                  "获取验证码按钮", "提交按钮", "取消按钮", "密码明文查看按钮", "密码清空按钮"],
            "involved_roles": ["忘记密码的B端产品用户"],
            "data_requirements": ["不存在的手机号", "7位的新密码", "只有数字的新密码", "与新密码不一致的确认密码",
                                  "过期的验证码", "未获取的验证码", "错误的验证码", "空的手机号输入", "空的新密码输入",
                                  "空的确认密码输入", "空的验证码输入", "符合要求的手机号、新密码、有效验证码"],
            "risk_assessment": "High，理由：涉及密码重置，是账号安全的重要环节，密码重置失败会导致用户无法恢复账号访问，且包含手机号、验证码等敏感信息校验。",
            "business_constraints": [
                "登录账号（手机号）存在于系统",
                "新密码不为空",
                "新密码长度为8-10位，且至少包含两种字符类型",
                "确认密码与新密码一致",
                "验证码不为空",
                "验证码正确且在有效期（60秒）内",
                "输入框获取焦点时提示文字消失，边框变绿；失去焦点恢复",
                "密码支持明文/密文切换（鼠标按下显示明文，松开恢复密文）",
                "密码输入框支持清空操作",
                "获取验证码按钮点击后显示60秒倒计时，倒计时结束后恢复",
                "取消按钮点击后返回登录页面"
            ],
            "planned_stream_a_scenarios": [
                "P0 Happy Path：输入存在的手机号、符合要求的新密码、确认密码、有效验证码，提交成功提示重置成功",
                "P1 手机号不存在：输入不存在的手机号，提交提示账号不存在",
                "P1 新密码长度不足：输入7位新密码，提交提示长度错误",
                "P1 新密码复杂度不足：输入只有数字的新密码，提交提示复杂度不足",
                "P1 确认密码不一致：输入与新密码不同的确认密码，提交提示不一致",
                "P1 验证码为空：输入空验证码，提交提示验证码不为空",
                "P1 验证码过期：获取验证码后等待60秒，输入原验证码提交提示失效"
            ],
            "planned_stream_b_scenarios": [
                "输入框焦点样式：点击手机号输入框，提示文字消失且边框变绿；失去焦点恢复",
                "密码明文/密文切换：按下新密码明文查看按钮显示明文，松开恢复密文",
                "密码清空操作：输入新密码后点击清空按钮，密码输入框清空",
                "获取验证码倒计时：点击获取验证码按钮，显示60秒倒计时，结束后恢复",
                "验证码有效期：等待60秒后输入原验证码，提交提示失效",
                "取消按钮跳转：点击取消按钮，返回登录页面"
            ],
            "planned_stream_c_scenarios": [
                "找回密码成功后登录：提交成功后返回登录页面，使用新密码登录成功",
                "找回密码失败后留在页面：输入错误信息，提交后提示错误留在页面",
                "验证码倒计时期间提交：倒计时期间输入验证码，提交成功（有效时）",
                "密码明文查看后提交：按下明文查看确认密码正确，松开后提交成功",
                "取消后重新找回：点击取消返回登录页面，再次点击找回密码进入页面",
                "找回密码后修改密码：登录后进入修改密码页面，使用新密码修改成功"
            ]
        },
        {
            "module_name": "修改密码",
            "identified_inputs": ["原密码输入框", "新密码输入框", "确认密码输入框", "验证码输入框", "获取验证码按钮",
                                  "提交按钮", "取消按钮", "密码明文查看按钮", "密码清空按钮"],
            "involved_roles": ["已登录的B端产品用户"],
            "data_requirements": ["错误的原密码", "7位的新密码", "只有数字的新密码", "与新密码不一致的确认密码",
                                  "过期的验证码", "未获取的验证码", "错误的验证码", "空的原密码输入", "空的新密码输入",
                                  "空的确认密码输入", "空的验证码输入", "正确的原密码、符合要求的新密码、有效验证码"],
            "risk_assessment": "High，理由：涉及密码修改，是账号安全的重要环节，密码修改失败会导致用户无法更新密码，且包含原密码、新密码、验证码等敏感信息校验。",
            "business_constraints": [
                "原密码不为空且与当前密码匹配",
                "新密码不为空",
                "新密码长度为8-10位，且至少包含两种字符类型",
                "确认密码与新密码一致",
                "验证码不为空",
                "验证码正确且在有效期（60秒）内",
                "输入框获取焦点时提示文字消失，边框变绿；失去焦点恢复",
                "密码支持明文/密文切换（鼠标按下显示明文，松开恢复密文）",
                "密码输入框支持清空操作",
                "获取验证码按钮点击后显示60秒倒计时，倒计时结束后恢复",
                "取消按钮点击后返回我的页面"
            ],
            "planned_stream_a_scenarios": [
                "P0 Happy Path：输入正确原密码、符合要求的新密码、确认密码、有效验证码，提交成功",
                "P1 原密码错误：输入错误原密码，提交提示原密码错误",
                "P1 新密码长度不足：输入7位新密码，提交提示长度错误",
                "P1 新密码复杂度不足：输入只有数字的新密码，提交提示复杂度不足",
                "P1 确认密码不一致：输入与新密码不同的确认密码，提交提示不一致",
                "P1 验证码为空：输入空验证码，提交提示验证码不为空",
                "P1 验证码过期：获取验证码后等待60秒，输入原验证码提交提示失效"
            ],
            "planned_stream_b_scenarios": [
                "输入框焦点样式：点击原密码输入框，提示文字消失且边框变绿；失去焦点恢复",
                "密码明文/密文切换：按下原密码明文查看按钮显示明文，松开恢复密文",
                "密码清空操作：输入原密码后点击清空按钮，密码输入框清空",
                "获取验证码倒计时：点击获取验证码按钮，显示60秒倒计时，结束后恢复",
                "验证码有效期：等待60秒后输入原验证码，提交提示失效",
                "取消按钮跳转：点击取消按钮，返回我的页面"
            ],
            "planned_stream_c_scenarios": [
                "修改密码成功后登录：使用新密码登录成功",
                "修改密码失败后留在页面：输入错误信息，提交后提示错误留在页面",
                "验证码倒计时期间提交：倒计时期间输入验证码，提交成功（有效时）",
                "密码明文查看后提交：按下明文查看确认密码正确，松开后提交成功",
                "取消后重新修改：点击取消返回我的页面，再次进入修改密码页面",
                "修改密码成功后再次修改：登录后进入修改密码页面，原密码失效，新密码可用于修改"
            ]
        }
    ],
    "cases": [
        {"module_name": "账号登录", "title": "P0 Happy Path：正确账号密码验证码登录（首次弹出改密提示）",
         "type": "Stream A", "pre_condition": "用户打开登录页面，准备输入账号、密码、验证码",
         "visual_evidence": "基于[参考图2-登录页面]的输入框布局和[参考图1-流程图]的登录成功分支",
         "steps": ["输入正确账号（参考图2账号输入框）", "输入正确密码（参考图2密码输入框）",
                   "输入有效验证码（参考图2验证码框）", "点击【登录】按钮"],
         "expected_result": "登录成功，首次登录弹出“修改初始密码”提示框"},
        {"module_name": "账号登录", "title": "P1 登录账号为空：输入空账号，点击登录提示账号不为空", "type": "Stream A",
         "pre_condition": "用户打开登录页面，账号输入框初始为空",
         "visual_evidence": "基于[参考图2-登录页面]的账号输入框", "steps": ["账号输入框不输入内容", "点击【登录】按钮"],
         "expected_result": "账号输入框下方红字提示“账号不为空”"},
        {"module_name": "账号登录", "title": "P1 登录账号不存在：输入不存在的账号，点击登录提示账号不存在",
         "type": "Stream A", "pre_condition": "用户打开登录页面，准备输入不存在的账号",
         "visual_evidence": "基于[参考图2-登录页面]的账号输入框",
         "steps": ["输入不存在的账号（参考图2账号输入框）", "输入任意密码（参考图2密码输入框）",
                   "输入任意验证码（参考图2验证码框）", "点击【登录】按钮"],
         "expected_result": "账号输入框下方红字提示“账号不存在”"},
        {"module_name": "账号登录", "title": "P1 登录密码为空：输入空密码，点击登录提示密码不为空", "type": "Stream A",
         "pre_condition": "用户打开登录页面，密码输入框初始为空",
         "visual_evidence": "基于[参考图2-登录页面]的密码输入框",
         "steps": ["输入正确账号（参考图2账号输入框）", "密码输入框不输入内容", "输入有效验证码（参考图2验证码框）",
                   "点击【登录】按钮"], "expected_result": "密码输入框下方红字提示“密码不为空”"},
        {"module_name": "账号登录", "title": "P1 登录密码错误：输入错误密码，点击登录提示密码错误", "type": "Stream A",
         "pre_condition": "用户打开登录页面，准备输入错误密码", "visual_evidence": "基于[参考图2-登录页面]的密码输入框",
         "steps": ["输入正确账号（参考图2账号输入框）", "输入错误密码（参考图2密码输入框）",
                   "输入有效验证码（参考图2验证码框）", "点击【登录】按钮"],
         "expected_result": "密码输入框下方红字提示“密码错误”"},
        {"module_name": "账号登录", "title": "P1 验证码为空：输入空验证码，点击登录提示验证码不为空", "type": "Stream A",
         "pre_condition": "用户打开登录页面，验证码输入框初始为空",
         "visual_evidence": "基于[参考图2-登录页面]的验证码输入框",
         "steps": ["输入正确账号（参考图2账号输入框）", "输入正确密码（参考图2密码输入框）", "验证码输入框不输入内容",
                   "点击【登录】按钮"], "expected_result": "验证码输入框下方红字提示“验证码不为空”"},
        {"module_name": "账号登录", "title": "P1 验证码过期：输入有效验证码后等待60秒，点击登录提示验证码失效",
         "type": "Stream A", "pre_condition": "用户打开登录页面，输入有效验证码后等待60秒（验证码过期）",
         "visual_evidence": "基于[参考图2-登录页面]的验证码区域和[参考图1-流程图]的验证码过期分支",
         "steps": ["输入正确账号（参考图2账号输入框）", "输入正确密码（参考图2密码输入框）",
                   "输入有效验证码（参考图2验证码框）", "等待60秒（验证码过期）", "点击【登录】按钮"],
         "expected_result": "验证码输入框下方红字提示“验证码失效”"},
        {"module_name": "重置初始密码", "title": "P0 Happy Path：符合要求的密码验证码提交成功", "type": "Stream A",
         "pre_condition": "用户首次登录后进入重置初始密码页面（参考图3）",
         "visual_evidence": "基于[参考图3-重置初始密码页面]和[参考图1-流程图]的重置成功分支",
         "steps": ["输入符合要求的新密码（参考图3新密码输入框）", "输入与新密码一致的确认密码（参考图3确认密码输入框）",
                   "输入有效验证码（参考图3验证码输入框）", "点击【提交】按钮"],
         "expected_result": "提示“重置密码成功”，返回登录页面"},
        {"module_name": "重置初始密码", "title": "P1 新密码为空：输入空新密码，提交提示密码不为空", "type": "Stream A",
         "pre_condition": "用户进入重置初始密码页面，新密码输入框初始为空",
         "visual_evidence": "基于[参考图3-重置初始密码页面]的新密码输入框",
         "steps": ["新密码输入框不输入内容", "输入确认密码（任意内容）", "输入有效验证码（参考图3验证码输入框）",
                   "点击【提交】按钮"], "expected_result": "新密码输入框下方红字提示“密码不为空”"},
        {"module_name": "重置初始密码", "title": "P1 新密码长度不足：输入7位新密码，提交提示长度错误", "type": "Stream A",
         "pre_condition": "用户进入重置初始密码页面，准备输入7位新密码",
         "visual_evidence": "基于[参考图3-重置初始密码页面]的新密码输入框",
         "steps": ["输入7位新密码（参考图3新密码输入框）", "输入与新密码一致的确认密码（参考图3确认密码输入框）",
                   "输入有效验证码（参考图3验证码输入框）", "点击【提交】按钮"],
         "expected_result": "新密码输入框下方红字提示“密码长度应为8-10位”"},
        {"module_name": "重置初始密码", "title": "P1 新密码复杂度不足：输入只有数字的新密码，提交提示复杂度不足",
         "type": "Stream A", "pre_condition": "用户进入重置初始密码页面，准备输入纯数字新密码",
         "visual_evidence": "基于[参考图3-重置初始密码页面]的新密码输入框",
         "steps": ["输入只有数字的新密码（参考图3新密码输入框）", "输入与新密码一致的确认密码（参考图3确认密码输入框）",
                   "输入有效验证码（参考图3验证码输入框）", "点击【提交】按钮"],
         "expected_result": "新密码输入框下方红字提示“密码复杂度不足（至少两种字符类型）”"},
        {"module_name": "重置初始密码", "title": "P1 确认密码不一致：输入与新密码不同的确认密码，提交提示不一致",
         "type": "Stream A", "pre_condition": "用户进入重置初始密码页面，准备输入不一致的确认密码",
         "visual_evidence": "基于[参考图3-重置初始密码页面]的确认密码输入框",
         "steps": ["输入符合要求的新密码（参考图3新密码输入框）", "输入与新密码不同的确认密码（参考图3确认密码输入框）",
                   "输入有效验证码（参考图3验证码输入框）", "点击【提交】按钮"],
         "expected_result": "确认密码输入框下方红字提示“确认密码与新密码不一致”"},
        {"module_name": "重置初始密码", "title": "P1 验证码为空：输入空验证码，提交提示验证码不为空", "type": "Stream A",
         "pre_condition": "用户进入重置初始密码页面，验证码输入框初始为空",
         "visual_evidence": "基于[参考图3-重置初始密码页面]的验证码输入框",
         "steps": ["输入符合要求的新密码（参考图3新密码输入框）", "输入与新密码一致的确认密码（参考图3确认密码输入框）",
                   "验证码输入框不输入内容", "点击【提交】按钮"],
         "expected_result": "验证码输入框下方红字提示“验证码不为空”"},
        {"module_name": "重置初始密码", "title": "P1 验证码过期：获取验证码后等待60秒，输入原验证码提交提示失效",
         "type": "Stream A", "pre_condition": "用户进入重置初始密码页面，已获取有效验证码并等待60秒（验证码过期）",
         "visual_evidence": "基于[参考图3-重置初始密码页面]的验证码区域和[参考图1-流程图]的验证码过期分支",
         "steps": ["点击【获取验证码】按钮（参考图3获取验证码按钮）", "等待60秒（验证码过期）",
                   "输入原验证码（参考图3验证码输入框）", "输入符合要求的新密码和确认密码（参考图3对应输入框）",
                   "点击【提交】按钮"], "expected_result": "验证码输入框下方红字提示“验证码失效”"},
        {"module_name": "找回密码", "title": "P0 Happy Path：存在手机号及合规密码验证码提交成功", "type": "Stream A",
         "pre_condition": "用户进入找回密码页面（参考图4），手机号存在于系统",
         "visual_evidence": "基于[参考图4-找回密码页面]和[参考图1-流程图]的找回成功分支",
         "steps": ["输入存在的手机号（参考图4手机号输入框）", "输入符合要求的新密码（参考图4新密码输入框）",
                   "输入与新密码一致的确认密码（参考图4确认密码输入框）", "输入有效验证码（参考图4验证码输入框）",
                   "点击【提交】按钮"], "expected_result": "提示“重置密码成功”，返回登录页面"},
        {"module_name": "找回密码", "title": "P1 手机号不存在：输入不存在的手机号，提交提示账号不存在",
         "type": "Stream A", "pre_condition": "用户进入找回密码页面，输入不存在的手机号",
         "visual_evidence": "基于[参考图4-找回密码页面]的手机号输入框",
         "steps": ["输入不存在的手机号（参考图4手机号输入框）", "输入符合要求的新密码和确认密码（参考图4对应输入框）",
                   "输入有效验证码（参考图4验证码输入框）", "点击【提交】按钮"],
         "expected_result": "手机号输入框下方红字提示“账号不存在”"},
        {"module_name": "找回密码", "title": "P1 新密码长度不足：输入7位新密码，提交提示长度错误", "type": "Stream A",
         "pre_condition": "用户进入找回密码页面，准备输入7位新密码",
         "visual_evidence": "基于[参考图4-找回密码页面]的新密码输入框",
         "steps": ["输入存在的手机号（参考图4手机号输入框）", "输入7位新密码（参考图4新密码输入框）",
                   "输入与新密码一致的确认密码（参考图4确认密码输入框）", "输入有效验证码（参考图4验证码输入框）",
                   "点击【提交】按钮"], "expected_result": "新密码输入框下方红字提示“密码长度应为8-10位”"},
        {"module_name": "找回密码", "title": "P1 新密码复杂度不足：输入只有数字的新密码，提交提示复杂度不足",
         "type": "Stream A", "pre_condition": "用户进入找回密码页面，准备输入纯数字新密码",
         "visual_evidence": "基于[参考图4-找回密码页面]的的新密码输入框",
         "steps": ["输入存在的手机号（参考图4手机号输入框）", "输入只有数字的新密码（参考图4新密码输入框）",
                   "输入与新密码一致的确认密码（参考图4确认密码输入框）", "输入有效验证码（参考图4验证码输入框）",
                   "点击【提交】按钮"], "expected_result": "新密码输入框下方红字提示“密码复杂度不足（至少两种字符类型）”"},
        {"module_name": "找回密码", "title": "P1 确认密码不一致：输入与新密码不同的确认密码，提交提示不一致",
         "type": "Stream A", "pre_condition": "用户进入找回密码页面，准备输入不一致的确认密码",
         "visual_evidence": "基于[参考图4-找回密码页面]的确认密码输入框",
         "steps": ["输入存在的手机号（参考图4手机号输入框）", "输入符合要求的新密码（参考图4新密码输入框）",
                   "输入与新密码不同的确认密码（参考图4确认密码输入框）", "输入有效验证码（参考图4验证码输入框）",
                   "点击【提交】按钮"], "expected_result": "确认密码输入框下方红字提示“确认密码与新密码不一致”"},
        {"module_name": "找回密码", "title": "P1 验证码为空：输入空验证码，提交提示验证码不为空", "type": "Stream A",
         "pre_condition": "用户进入找回密码页面，验证码输入框初始为空",
         "visual_evidence": "基于[参考图4-找回密码页面]的验证码输入框",
         "steps": ["输入存在的手机号（参考图4手机号输入框）", "输入符合要求的新密码和确认密码（参考图4对应输入框）",
                   "验证码输入框不输入内容", "点击【提交】按钮"],
         "expected_result": "验证码输入框下方红字提示“验证码不为空”"},
        {"module_name": "找回密码", "title": "P1 验证码过期：获取验证码后等待60秒，输入原验证码提交提示失效",
         "type": "Stream A", "pre_condition": "用户进入找回密码页面，已获取有效验证码并等待60秒（验证码过期）",
         "visual_evidence": "基于[参考图4-找回密码页面]的验证码区域和[参考图1-流程图]的验证码过期分支",
         "steps": ["点击【获取验证码】按钮（参考图4获取验证码按钮）", "等待60秒（验证码过期）",
                   "输入原验证码（参考图4验证码输入框）",
                   "输入存在的手机号、符合要求的新密码和确认密码（参考图4对应输入框）", "点击【提交】按钮"],
         "expected_result": "验证码输入框下方红字提示“验证码失效”"},
        {"module_name": "修改密码", "title": "P0 Happy Path：正确原密码及合规新密码验证码提交成功", "type": "Stream A",
         "pre_condition": "用户已登录，进入修改密码页面（参考图5），原密码正确",
         "visual_evidence": "基于[参考图5-修改密码页面]和[参考图1-流程图]的修改成功分支",
         "steps": ["输入正确原密码（参考图5原密码输入框）", "输入符合要求的新密码（参考图5新密码输入框）",
                   "输入与新密码一致的确认密码（参考图5确认密码输入框）", "输入有效验证码（参考图5验证码输入框）",
                   "点击【提交】按钮"], "expected_result": "提示“重置密码成功”"},
        {"module_name": "修改密码", "title": "P1 原密码错误：输入错误原密码，提交提示原密码错误", "type": "Stream A",
         "pre_condition": "用户已登录，进入修改密码页面，准备输入错误原密码",
         "visual_evidence": "基于[参考图5-修改密码页面]的原密码输入框",
         "steps": ["输入错误原密码（参考图5原密码输入框）", "输入符合要求的新密码和确认密码（参考图5对应输入框）",
                   "输入有效验证码（参考图5验证码输入框）", "点击【提交】按钮"],
         "expected_result": "原密码输入框下方红字提示“原密码错误”"},
        {"module_name": "修改密码", "title": "P1 新密码长度不足：输入7位新密码，提交提示长度错误", "type": "Stream A",
         "pre_condition": "用户已登录，进入修改密码页面，准备输入7位新密码",
         "visual_evidence": "基于[参考图5-修改密码页面]的新密码输入框",
         "steps": ["输入正确原密码（参考图5原密码输入框）", "输入7位新密码（参考图5新密码输入框）",
                   "输入与新密码一致的确认密码（参考图5确认密码输入框）", "输入有效验证码（参考图5验证码输入框）",
                   "点击【提交】按钮"], "expected_result": "新密码输入框下方红字提示“密码长度应为8-10位”"},
        {"module_name": "修改密码", "title": "P1 新密码复杂度不足：输入只有数字的新密码，提交提示复杂度不足",
         "type": "Stream A", "pre_condition": "用户已登录，进入修改密码页面，准备输入纯数字新密码",
         "visual_evidence": "基于[参考图5-修改密码页面]的新密码输入框",
         "steps": ["输入正确原密码（参考图5原密码输入框）", "输入只有数字的新密码（参考图5新密码输入框）",
                   "输入与新密码一致的确认密码（参考图5确认密码输入框）", "输入有效验证码（参考图5验证码输入框）",
                   "点击【提交】按钮"], "expected_result": "新密码输入框下方红字提示“密码复杂度不足（至少两种字符类型）”"},
        {"module_name": "修改密码", "title": "P1 确认密码不一致：输入与新密码不同的确认密码，提交提示不一致",
         "type": "Stream A", "pre_condition": "用户已登录，进入修改密码页面，准备输入不一致的确认密码",
         "visual_evidence": "基于[参考图5-修改密码页面]的确认密码输入框",
         "steps": ["输入正确原密码（参考图5原密码输入框）", "输入符合要求的新密码（参考图5新密码输入框）",
                   "输入与新密码不同的确认密码（参考图5确认密码输入框）", "输入有效验证码（参考图5验证码输入框）",
                   "点击【提交】按钮"], "expected_result": "确认密码输入框下方红字提示“确认密码与新密码不一致”"},
        {"module_name": "修改密码", "title": "P1 验证码为空：输入空验证码，提交提示验证码不为空", "type": "Stream A",
         "pre_condition": "用户已登录，进入修改密码页面，验证码输入框初始为空",
         "visual_evidence": "基于[参考图5-修改密码页面]的验证码输入框",
         "steps": ["输入正确原密码（参考图5原密码输入框）", "输入符合要求的新密码和确认密码（参考图5对应输入框）",
                   "验证码输入框不输入内容", "点击【提交】按钮"],
         "expected_result": "验证码输入框下方红字提示“验证码不为空”"},
        {"module_name": "修改密码", "title": "P1 验证码过期：获取验证码后等待60秒，输入原验证码提交提示失效",
         "type": "Stream A", "pre_condition": "用户已登录，进入修改密码页面，已获取有效验证码并等待60秒（验证码过期）",
         "visual_evidence": "基于[参考图5-修改密码页面]的验证码区域和[参考图1-流程图]的验证码过期分支",
         "steps": ["点击【获取验证码】按钮（参考图5获取验证码按钮）", "等待60秒（验证图5验证码过期）",
                   "输入原验证码（参考图5验证码输入框）", "输入正确原密码、符合要求的新密码和确认密码（参考图5对应输入框）",
                   "点击【提交】按钮"], "expected_result": "验证码输入框下方红字提示“验证码失效”"}
    ],
    "images": {}
}


@app.post("/generate_from_feishu")
async def generate_cases(request: FeishuRequest):
    print(f"收到请求: URL={request.doc_url}")
    # ... (MOCK 流式生成逻辑不变)
    async def event_generator():
        try:
            yield json.dumps({"type": "log", "message": "正在连接飞书文档 (Mock)..."}) + "\n"
            await asyncio.sleep(0.5)
            yield json.dumps({"type": "log", "message": "正在解析业务流程图与UI规则 (Mock)..."}) + "\n"
            await asyncio.sleep(1.0)

            # 1. 发送图片 (Mock)
            yield json.dumps({"type": "images", "data": MOCK_DATA_ALL["images"]}) + "\n"

            # 2. 发送分析结果 (Mock)
            analysis_data = MOCK_DATA_ALL["analysis"]
            yield json.dumps({"type": "analysis", "data": analysis_data}) + "\n"
            yield json.dumps({"type": "log", "message": "策略制定完成，正在生成详细测试用例 (Mock)..."}) + "\n"
            await asyncio.sleep(1.5)

            # 3. 发送用例结果 (Mock)
            cases_data = MOCK_DATA_ALL["cases"]
            yield json.dumps({"type": "cases", "data": cases_data}) + "\n"

            yield json.dumps({"type": "done", "message": "Mock 生成完毕"}) + "\n"

        except Exception as e:
            error_msg = traceback.format_exc()
            print(f"🔥 Mock 流程异常: {e}")
            yield json.dumps({"type": "error", "message": str(e)}) + "\n"

    return StreamingResponse(event_generator(), media_type="application/x-ndjson")


# --- 新增接口: 保存结果到数据库 ---
@app.post("/save_result")
async def save_case_result(req: CaseSaveRequest):
    try:
        # url 返回 '/?key={unique_key}'
        unique_key = save_result(req.final_json)
        return {"key": unique_key, "url": f"/?key={unique_key}"}
    except Exception as e:
        print(f"🔥 保存异常: {e}")
        raise HTTPException(status_code=500, detail=f"保存失败: {str(e)}")


# --- 新增接口: 根据 Key 加载结果 ---
@app.get("/load/{key}")
async def load_case_result(key: str):
    """根据 Key 获取已保存的 JSON 结果"""
    result = get_result_by_key(key)
    if result:
        return result
    else:
        raise HTTPException(status_code=404, detail="未找到对应的测试用例结果")


# --- 前端托管配置 ---

# 1. 挂载静态文件目录 (用于加载 test_case_web.html 中的静态资源，例如markmap)
# 假设所有静态文件都在当前目录
app.mount("/static", StaticFiles(directory="."), name="static")

# 2. 根路由，返回 HTML 文件
@app.get("/", response_class=HTMLResponse)
async def serve_frontend():
    """访问 http://localhost:8000/ 时返回 test_case_web.html"""
    try:
        # 注意: 确保 test_case_web.html 文件存在于运行 test.py 的目录下
        with open("test_case_web.html", "r", encoding="utf-8") as f:
            html_content = f.read()
        return HTMLResponse(content=html_content)
    except FileNotFoundError:
        return HTMLResponse(content="<h1>Error: test_case_web.html not found.</h1>", status_code=404)


if __name__ == "__main__":
    # 使用 8000 端口同时提供前端和 API 服务
    uvicorn.run(app, host="0.0.0.0", port=8000)